# functionalscenes
![](../gif/6.主页瀑布流实现.gif)

## 属性和状态
组件 `FunctionalScenes` 实现了一个具有可点击标签的滚动页面。其中的SceneModuleInfo， WaterFlowDataSource均为自定义组件，而TabsController和Scroller均为内置sdk。
```ts
@Component
export struct FunctionalScenes {
    @Link listData: SceneModuleInfo[];
    dataSource: WaterFlowDataSource = new WaterFlowDataSource(this.listData);
    @State tabsIndex: number = 0;
    tabsController: TabsController = new TabsController();
    private scrollController: Scroller = new Scroller();
```
- `listData: SceneModuleInfo[]`: 通过 `@Link` 装饰器与外部数据绑定的场景模块信息列表。
- `dataSource: WaterFlowDataSource`: 使用 `listData` 初始化的瀑布流数据源。
- `tabsIndex: number`: 当前选中的标签索引。
- `tabsController: TabsController`: 控制标签切换的控制器。
- `scrollController: Scroller`: 控制滚动的控制器。
<br/>

## SceneModuleInfo
`SceneModuleInfo` 类用于表示应用场景模块的信息，包括首页列表图片、名称、路由信息、传参数据、难度星级和分类等。可以通过构造函数初始化各个属性，并提供默认值处理。
```ts
export class SceneModuleInfo {
  // 首页列表图片
  imageSrc: ResourceStr;
  // 首页列表名称
  name: string;
  // 路由信息，自动生成路由时，在自定义装饰器中AppRouter中配置的参数，使用新版本自动路由时需要添加此参数，用于动态路由的跳转。使用规则：模块名/需要加载的自定义组件名，如addressexchange/AddressExchangeView
  appUri: string;
  // 路由传参数据
  param: string;
  // 难度星级
  ratingNumber: number;
  // 分类
  category: string;

  constructor(imageSrc: ResourceStr, name: string, appUri: string, category: string, ratingNumber?: number, param?: string) {
    this.imageSrc = imageSrc;
    this.name = name;
    this.appUri = appUri;
    this.param = param === undefined ? '' : param;
    this.ratingNumber = ratingNumber === undefined ? 2 : ratingNumber;
    this.category = category;
  }
}
```
<br/>

## WaterFlowDataSource
用于管理和通知数据变化。它实现了 `IDataSource` 接口，并提供了一系列方法来操作数据和通知监听器数据的变化。
- **getData(index: number): SceneModuleInfo**
  - 根据索引获取数据。
  - **index**: 数组索引。
  - **返回值**: `SceneModuleInfo` 对象。

- **notifyDataReload(): void**
  - 通知监听器数据重新加载。

- **notifyDataAdd(index: number): void**
  - 通知监听器数据增加。
  - **index**: 数据增加的位置索引。

- **notifyDataChange(index: number): void**
  - 通知监听器数据变化。
  - **index**: 数据变化的位置索引。

- **notifyDataDelete(index: number): void**
  - 通知监听器数据删除。
  - **index**: 数据删除的位置索引。

- **notifyDataMove(from: number, to: number): void**
  - 通知监听器数据位置变化。
  - **from**: 起始位置索引。
  - **to**: 最终位置索引。

- **totalCount(): number**
  - 获取数据总数。
  - **返回值**: 数据总数。

- **registerDataChangeListener(listener: DataChangeListener): void**
  - 注册数据变化监听器。
  - **listener**: 数据变化监听器。

- **unregisterDataChangeListener(listener: DataChangeListener): void**
  - 注销数据变化监听器。
  - **listener**: 数据变化监听器。

- **add1stItem(): void**
  - 在数据首部增加一个元素，并通知监听器数据增加。

- **addLastItem(): void**
  - 在数据尾部增加一个元素，并通知监听器数据增加。

- **addItem(index: number): void**
  - 在指定索引位置增加一个元素，并通知监听器数据增加。
  - **index**: 插入元素的位置索引。

- **delete1stItem(): void**
  - 删除第一个元素，并通知监听器数据删除。

- **delete2ndItem(): void**
  - 删除第二个元素，并通知监听器数据删除。

- **deleteLastItem(): void**
  - 删除最后一个元素，并通知监听器数据删除。

- **reload(): void**
  - 重新加载数据，并通知监听器数据重新加载。

- **modifyAllData(data: SceneModuleInfo[]): void**
  - 修改整个数据数组，并通知监听器数据重新加载。
  - **data**: 新的 `SceneModuleInfo` 数组。

在上面这个新建类中，我们使用到了DataChangeListener。其主要作用就是监听数据源的数据变化事件，这个接口定义了一些方法，当数据源的数据发生变化时，这些方法会被调用，从而通知相应的组件进行更新。
* onDataReloaded(): 通知监听器数据需要重新加载。
* onDataAdd(index: number): 通知监听器在指定索引处新增数据项。
* onDataChange(index: number): 通知监听器在指定索引处的数据项发生变化。
* onDataDelete(index: number): 通知监听器在指定索引处的数据项被删除。
* onDataMove(from: number, to: number): 通知监听器数据项在数组中的位置发生变化。
<br/>

## TabsData
### TabDataModel
`TabDataModel` 类用于表示单个 Tab 的数据模型。它包含两个属性：`id` 和 `navData`，用于标识 Tab 和存储 Tab 的名称。

### BasicDataSource
`BasicDataSource` 类实现了 `IDataSource` 接口，提供了基础的数据源操作和监听功能。
- **totalCount(): number**
  - 获取数据总数。
  - **返回值**: 数据总数。

- **getData(index: number): TabDataModel**
  - 根据索引获取数据。
  - **index**: 数组索引。
  - **返回值**: `TabDataModel` 对象。

- **registerDataChangeListener(listener: DataChangeListener): void**
  - 注册数据变化监听器，为 LazyForEach 组件向其数据源处添加监听器。
  - **listener**: 数据变化监听器。

- **unregisterDataChangeListener(listener: DataChangeListener): void**
  - 注销数据变化监听器，为 LazyForEach 组件在数据源处去除监听器。
  - **listener**: 数据变化监听器。

- **notifyDataReload(): void**
  - 通知监听器数据重新加载，通知 LazyForEach 组件需要重载所有子组件。

- **notifyDataAdd(index: number): void**
  - 通知监听器数据增加，通知 LazyForEach 组件在 index 对应索引处添加子组件。
  - **index**: 数据增加的位置索引。

- **notifyDataChange(index: number): void**
  - 通知监听器数据变化，通知 LazyForEach 组件在 index 对应索引处数据有变化，需要重建该子组件。
  - **index**: 数据变化的位置索引。

- **notifyDataDelete(index: number): void**
  - 通知监听器数据删除，通知 LazyForEach 组件需要在 index 对应索引处删除该子组件。
  - **index**: 数据删除的位置索引。

### TabDataSource
`TabDataSource` 类继承了 `BasicDataSource`，实现了具体的 `TabDataModel` 数据源操作。
- **totalCount(): number**
  - 获取数据总数。
  - **返回值**: 数据总数。

- **getData(index: number): TabDataModel**
  - 根据索引获取数据。
  - **index**: 数组索引。
  - **返回值**: `TabDataModel` 对象。

- **addData(index: number, data: TabDataModel): void**
  - 在指定索引位置增加一个元素。
  - **index**: 数组索引。
  - **data**: 要增加的 `TabDataModel` 对象。

- **pushData(data: TabDataModel): void**
  - 在数据尾部增加一个元素。
  - **data**: 要增加的 `TabDataModel` 对象。
<br/>

## tabBuilder
`tabBuilder` 方法用于构建标签栏中的单个标签项，根据索引和名称动态设置标签项的样式和行为。
- **Stack**
  - 包含标签项内容的堆叠容器。
  - **Column**
    - 空的 Column 布局，用于设置标签项的背景。
    - **width**: 根据当前标签项是否被选中设置宽度。
    - **backgroundColor**: 根据当前标签项是否被选中设置背景颜色。
    - **opacity**: 根据当前标签项是否被选中设置不透明度。
    - **height**: 设置标签项的高度。
    - **borderRadius**: 设置标签项的圆角半径。

  - **Text**
    - 显示标签项的名称。
    - **fontSize**: 设置字体大小。
    - **fontColor**: 根据当前标签项是否被选中设置字体颜色。
    - **opacity**: 根据当前标签项是否被选中设置不透明度。
    - **height**: 设置文本的高度。

- **margin**
  - 设置标签项的左边距，除第一个和最后一个标签项外，其他标签项设置统一的左边距。

- **align**
  - 设置标签项内容的对齐方式为居中。

- **onClick**
  - 点击事件处理器，点击标签项时，将 `tabsIndex` 设置为当前索引，并调用 `tabsController.changeIndex` 方法切换标签页。
<br/>
<br/>

TabsController 是用于控制和管理 Tabs 组件行为的控制器。它提供了一些方法和属性来帮助开发者管理选项卡的状态和行为。下面使TabsController 主要方法：
* changeIndex(index: number): void
切换到指定索引的选项卡。
* currentIndex(): number
获取当前选项卡的索引。
<br/>

## tabsMenu
`tabsMenu` 方法用于构建标签栏菜单，根据 `TAB_DATA` 数组动态生成菜单项，并为每个菜单项设置点击事件。
- **Menu**
  - 菜单容器，包含所有标签项。
  
  - **ForEach**
    - 遍历 `TAB_DATA` 数组，为每个标签项生成一个菜单项。
    
    - **MenuItem**
      - 每个标签项的菜单项。
      - **content**: 设置菜单项的内容为 `TAB_DATA` 中对应的 `navData`。
      - **onClick**: 点击事件处理器，点击菜单项时执行以下操作：
        - 将 `tabsIndex` 设置为当前标签项的 `id`。
        - 调用 `tabsController.changeIndex` 方法切换到当前标签项。
        - 如果当前标签项的 `id` 大于 2，则调用 `scrollController.scrollToIndex` 方法滚动到对应的索引位置。
<br/>
<br/>

### Scroller
Scroller 是用于管理滚动视图的控制器。它提供了一些方法和属性来帮助开发者控制滚动视图的行为和状态。其功能包括：控制滚动视图的偏移，处理滚动事件，程序化地滚动视图。其主要方法如下:
* scrollTo(offset: number): void
滚动到指定偏移位置。
* scrollToIndex(index: number): void
滚动到指定索引位置。
* currentOffset(): { xOffset: number, yOffset: number }
获取当前滚动偏移。
* onScroll(callback: (offset: { xOffset: number, yOffset: number }) => void): void
注册滚动事件的回调函数。
<br/>

## build
- **Column**: 使用 Column 布局将所有内容垂直排列。
  - **Row**: 顶部导航栏。
    - **Stack**: 包含 List 和更多按钮。
      - **List**: 使用 List 组件展示 Tab 数据。
        - **scroller**: 使用 `this.scrollController` 控制滚动。
        - **ForEach**: 遍历 `TAB_DATA` 数组，生成每个 Tab 项。
          - **ListItem**: 包含每个 Tab 项的内容。
            - **tabBuilder**: 调用自定义方法 `tabBuilder` 生成每个 Tab 的内容。
        - **margin**: 设置 List 上边距。
        - **height**: 设置 List 高度。
        - **listDirection**: 设置列表方向为水平。
        - **padding**: 设置 List 右边距。
        - **scrollBar**: 关闭滚动条。
      - **Row**: 包含更多按钮。
        - **Row**: 包含更多按钮图标。
          - **Image**: 显示更多按钮图标。
            - **width**: 设置图标宽度。
          - **bindMenu**: 绑定 `tabsMenu` 菜单。
          - **justifyContent**: 设置内容对齐方式为居中。
          - **width**: 设置按钮背景宽度。
          - **height**: 设置按钮背景高度。
          - **borderRadius**: 设置按钮背景圆角。
          - **backgroundColor**: 设置按钮背景颜色。
        - **linearGradient**: 设置背景颜色渐变。
          - **angle**: 设置渐变角度为 90 度。
          - **colors**: 设置渐变颜色。
        - **justifyContent**: 设置内容对齐方式为右对齐。
        - **width**: 设置按钮所在行的宽度。
        - **height**: 设置按钮所在行的高度。
      - **alignContent**: 设置内容对齐方式为右对齐。
  - **padding**: 设置顶部导航栏左右内边距。
  - **margin**: 设置顶部导航栏上边距。

  - **Tabs**: 使用 Tabs 组件管理多个选项卡内容。
  - **controller**: 使用 `this.tabsController` 控制选项卡。
    - **ForEach**: 遍历 `TAB_DATA` 数组，生成每个选项卡内容。
      - **TabContent**: 包含每个选项卡的内容。
        - **WaterFlow**: 使用 WaterFlow 组件展示瀑布流内容。
          - **LazyForEach**: 懒加载数据源 `this.dataSource`，生成每个瀑布流项。
            - **FlowItem**: 包含每个瀑布流项的内容。
              - **if 条件**: 判断是否展示 `waterFlowItem`。
                - **methodPoints**: 调用自定义方法 `methodPoints`，传入 `waterFlowItem` 数据。
          - **nestedScroll**: 设置嵌套滚动模式。
            - **scrollForward**: 设置前滚动模式为 `PARENT_FIRST`。
            - **scrollBackward**: 设置后滚动模式为 `SELF_FIRST`。
          - **cachedCount**: 设置缓存数量为 1。
          - **columnsTemplate**: 设置列模板为 '1fr 1fr'。
          - **columnsGap**: 设置列间距。
          - **width**: 设置 WaterFlow 宽度为 100%。
        - **backgroundColor**: 设置背景颜色为 `#F1F1F1`。
  - **margin**: 设置 Tabs 组件的上边距。
  - **barBackgroundColor**: 设置选项卡栏背景颜色为白色。
  - **padding**: 设置选项卡栏左右内边距。
  - **barWidth**: 设置选项卡栏宽度为 0。
  - **barHeight**: 设置选项卡栏高度为 0。
  - **onChange**: 选项卡切换时触发事件。
    - **this.tabsIndex**: 更新选项卡索引。
    - **this.scrollController.scrollToIndex**: 滚动到对应的索引。
- **padding**: 设置组件底部内边距。
- **height**: 设置组件高度为 100%。
- **backgroundColor**: 设置组件背景颜色为 `#F1F1F1`。
<br/>

### TabContent
TabContent 是一个用于定义选项卡内容的组件。每个 TabContent 代表一个选项卡的内容，当对应的选项卡被激活时，该内容将会显示。其功能包括：容纳选项卡内容和动态内容加载。
<br/>

### WaterFlow
WaterFlow 组件用于实现瀑布流布局（Waterfall Flow Layout），这种布局方式适用于展示大量图片、商品等高度不固定的内容。WaterFlow 组件会自动根据内容的高度调整每一列的高度，使得内容能够紧凑排列，提高空间利用率。其功能包括：自动布局，延迟加载，滚动支持。
<br/>

### LazyForEach
LazyForEach 组件用于高效地渲染和管理大数据集，它可以根据用户的滚动行为逐步加载和显示数据，从而提高应用程序的性能，尤其是在处理大量数据时。LazyForEach 组件通过懒加载机制，只加载用户当前可见范围内的数据项，其余的数据项在用户滚动到时才会加载。其主要功能包括：懒加载， 高效渲染和滚动支持。其包括如下参数:
1. 数据源（dataSource）：
* 类型：IDataSource
* 说明：提供数据项的来源，必须实现 IDataSource 接口。
2. 渲染函数（renderFunction）：
* 类型：(item: T, index: number) => VNode
* 说明：用于渲染每个数据项的函数。参数包括数据项和数据项索引，返回值为虚拟节点。
3. 键函数（keyFunction， 可选）：
* 类型：(item: T) => string | number
* 说明：用于生成每个数据项的唯一键。帮助 LazyForEach 跟踪和管理数据项的变化。
<br/>

### cachedCount(1)
cachedCount 定义了缓存的项目数量。缓存数量为 1 意味着只会缓存一个项目，减少内存使用，但同时可能会增加滚动时的重新渲染次数。在此上下文中，缓存一个项目可以在节省内存和滚动性能之间取得平衡。
<br/>

### columnsTemplate('1fr 1fr')
columnsTemplate 定义了列的布局模板。'1fr 1fr' 表示将可用空间均分为两列。这种设置适用于需要在页面上均匀排列多个元素的情况，有助于创建一致且对称的布局。
<br/>

### nestedScroll
nestedScroll 方法用于配置组件在嵌套滚动场景中的滚动行为。嵌套滚动是指在一个滚动容器内包含另一个滚动容器的情况，nestedScroll 方法可以控制内外滚动容器之间的滚动行为和优先级。<br/>
nestedScroll 方法接受一个对象参数，该对象包含以下属性：
* scrollForward: 指定在向前滚动（例如向下滚动页面）时的滚动模式。
* scrollBackward: 指定在向后滚动（例如向上滚动页面）时的滚动模式。<br/>
每个属性可以设置以下滚动模式之一：
* NestedScrollMode.PARENT_FIRST: 优先滚动父容器。
* NestedScrollMode.SELF_FIRST: 优先滚动当前容器。
<br/>

## methodPoints
* @Reusable 和 @Component 装饰器，该组件可以在应用的不同地方被实例化和使用。
* listData: 使用 @State 装饰器，表示当前显示的场景模块信息。
* screenW: 使用 @State 装饰器，表示屏幕宽度。
* isNeedClear: 使用 @State 装饰器，表示是否需要清除某些状态。
* deviceSize: 私有属性，表示设备尺寸阈值，默认为 600。
* curFoldStatus: 当前屏幕折叠状态，仅在折叠屏设备下有效。
<br/>

### px2vp
px2vp 函数用于将像素单位（px）转换为视口单位（vp）。在用户界面设计中，不同设备的屏幕尺寸和分辨率各不相同，为了使界面在不同设备上保持一致的视觉效果，通常需要将像素单位转换为视口单位。

### aboutToAppear
aboutToAppear 方法在组件即将显示时执行一些初始化操作，通过判断设备类型和屏幕尺寸，设置相应的状态和监听器，以便组件能够根据设备的不同特性进行适配和响应。

### aboutToReuse
组件能够在重用时接收新的参数，并更新其状态，从而显示最新的数据。

### regDisplayListener
regDisplayListener 方法通过监听设备的折叠状态变化，实时更新组件的显示状态，确保在不同的折叠状态下有相应的展示效果。

### changeNeedClear
changeNeedClear 方法用于根据设备的折叠状态更新组件的 isNeedClear 状态。这个状态决定了在当前折叠状态下是否需要清除显示内容。

## build
- **Column**: 使用 Column 布局将所有内容垂直排列。
  - **Image**: 显示模块的图片。
    - **borderRadius**: 设置图片的圆角。
    - **objectFit**: 设置图片的填充方式为包含。
    - **width**: 设置图片宽度为100%。
  - **Text**: 显示模块的名称。
    - **padding**: 设置文本的左右内边距。
    - **width**: 设置文本宽度为100%。
    - **fontColor**: 设置文本颜色为黑色。
    - **textAlign**: 设置文本对齐方式为左对齐。
    - **maxLines**: 设置文本最大行数为2行。
    - **fontSize**: 设置文本字体大小。
    - **margin**: 设置文本的上下边距。
    - **textOverflow**: 设置文本溢出时的显示方式为省略号。
  - **Row**: 显示难度评级。
    - **Text**: 显示难度文本。
      - **fontColor**: 设置文本颜色为黑色。
      - **opacity**: 设置文本透明度。
      - **textAlign**: 设置文本对齐方式为左对齐。
      - **maxLines**: 设置文本最大行数为1行。
      - **height**: 设置文本高度。
      - **fontSize**: 设置文本字体大小。
    - **Rating**: 显示难度星级评分。
      - **rating**: 设置评分值。
      - **indicator**: 设置评分组件为只读模式。
      - **stars**: 设置评分组件的星星数量。
    - **margin**: 设置Row组件的底部边距。
    - **padding**: 设置Row组件的左右内边距。
    - **width**: 设置Row组件宽度为100%。
    - **justifyContent**: 设置Row组件的子组件在主轴方向上的对齐方式为末端对齐。
  - **linearGradient**: 设置列组件的背景渐变色。
    - **angle**: 设置渐变角度为180度。
    - **colors**: 设置渐变颜色。
  - **width**: 设置列组件的宽度。
  - **borderRadius**: 设置列组件的圆角。
  - **margin**: 设置列组件的上下边距。
  - **onClick**: 设置点击事件。
    - **DynamicsRouter.clear()**: 在平板设备上点击清除路由栈。
    - **DynamicsRouter.pushUri()**: 根据点击的模块信息，将页面放入路由栈。









  



































  












